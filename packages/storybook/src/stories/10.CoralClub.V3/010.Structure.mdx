import { Canvas, Meta, Subtitle } from '@storybook/blocks'

import * as Structure from './010.Structure.stories';

<Meta of={Structure}/>

# Структура сайта
<Subtitle>
  Сайт реализуется по схеме микросервис/микрофронтенд.
</Subtitle>

### Что учитывать при создании
* Каждая независимая функциональная страница (каталог, регистрация, корзина, новости и т.д.) - это
отдельный независимый проект со своей командой разработчиков.
* Каждый функционал, который можно использовать в нескольких проектах, должен реализовываться как отдельная библиотека.
* Возможности работать с vue, nuxt и рендеринг на стороне сервера (SSR)
* При первом открытии страницы для полного формирования страницы не должно быть никаких запросов на стороне сервера.
Все данные должны быть заранее подгружены в index файле. Это для лучшей работы поисковиков и опыта использования пользователей.

### Что нужно
Нам нужен простой сервер, который бы объединял все наши микрофронтенды в одну страницу,
а также выполнял запросы, чтобы передать клиенту все данные.

### Какие есть готовые решения
Решения, которые работают на стороне клиента, такие как **Module Federation** и **Single-SPA**, нам не подходят.
Так как нам нужно не просто подготовить готовый файл, но и добавлять данные из запросов.
Самое близкое решение - это **Podium**, но он старый и не популярный, к тому же там много настроек, много лишнего из коробки.

В итоге будем пилить свой, так как это не так уж и трудно, и наше решение будет простым,
но полностью под нашими требованиями.

## Реализация
Серверная часть будет работать на **Nitro**.

> **Nitro** - это самое новое решение для серверной части на движке Node.js.
Из коробки он уже поддерживает роутер, кэш, и инструменты для запросов локального характера.

### Как работает

Для каждого Route прописывается вручную и выполняет два действия:
* выполняет запрос для получения данных;
* подключение нужного проекта для вывода.

#### Пример для страницы продукта
```js
// server/routes/product.ts
export default eventHandler(async (event) => {
  const data = await $fetch(`api.coral.club/product/${getQuery(event)?.item}/`)

  if (data) {
    return content({
      title: 'title',
      project: 'product',
      data
    })
  } else {
    return content({ project: '404' })
  }
})
```

### Структура проектов и библиотек
Можно разделить на 3 уровень
* **1 уровень**. Это самый важный, в нем хранится код ядра Vue, все зависимые пакеты, а также сама система дизайна.
**Если он сломается, весь сайт упадет.**
* **2 уровень**. Это библиотеки, которые автоматически подключаются при использовании.
Каждая библиотека будет выполнять лишь набор функций для конкретного проекта.
В ней могут быть функции, классы, API, компоненты.
Например, библиотека продукта будет хранить API для получения информации о продукте,
компоненты для отображения карты продуктов.
**Если он сломается, упадет только та часть компонента, которая его использует, а не весь проект.**
* **3 уровень**. Это сами проекты. Это конечный продукт, который видит клиент.
Это может быть часть страницы (header/footer) или полноценный функционал (регистрация, страница заказа).
На одной странице может быть любое количество проектов, но я против этого.
Предпочитаю разделение на уровень страницы/функционала.
То есть, например, на странице будет проект для отображения header/footer, отображения информации о продукте и образный связь.

<Canvas of={Structure.Cc3Structure}/>

> Разделение на библиотеки и проекты нужно для переиспользования.
Такой подход позволяет разработчику легче ориентироваться в коде и использовать функционал
из любой библиотеки на любом проекте. Например, на проекте новостей нужно подключить карту продукта,
я захожу в библиотеку продуктов, и вижу только те компоненты, которые доступны для подключения.

### Как с этим работать
Структура у библиотеки и проектов будет одинакова. Разница только в настройке конфигурации Vite.
Но библиотека может быть только на чистом Vue, а проекты могут быть и на чистом Vue и на Nuxt.

Подключение функционала библиотеки будет происходить просто через import, то есть стандартно.

#### Пример
Подключения API для получения информации о продукте из библиотеки продуктов
```js
// components.vue
<script setup>
import { useProductItem } from 'cc3/product'

const item = useProductItem(123456)
</script>
```
### Технический демо
Я собрал из говна и палки пример того, как все будет выглядеть
* сайт: [171.244.62.50:3500](http://171.244.62.50:3500/ "171.244.62.50:3500")
* git: [ssr-nitro](https://github.com/dxtmisha/ssr-nitro "ssr-nitro")

http://171.244.62.50:3500/project-nuxt-server/ - это рендеринг на стороне сервера
